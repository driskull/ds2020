<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>Grid view - helloWorld</title>

    <style>
      html,
      body {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
      }

      .container {
        height: 100%;
        width: 100%;
      }

      .esri-grid {
        width: 100%;
        height: 100%;
      }

      .esri-grid__content {
        width: 100%;
        height: 100%;
      }

      .esri-grid vaadin-grid {
        height: 100%;
        width: 100%;
      }
    </style>

    <link rel="stylesheet" href="../../../../../esri/css/main.css" />
    <script src="../../../../dojo-config.js"></script>
    <script src="../../../../../dojo/dojo.js"></script>

    <script>
      require([
        "esri/layers/FeatureLayer",
        "esri/widgets/FeatureTable/support/FeatureStore",
        "esri/widgets/FeatureTable/Grid/Column",
        "esri/widgets/FeatureTable/Grid/Grid",
        "esri/widgets/FeatureTable/Grid/GridViewModel"
      ], function(FeatureLayer, FeatureStore, Column, Grid, GridViewModel) {
        const layer = new FeatureLayer({
          url:
            "https://services.arcgis.com/V6ZHFr6zdgNZuVG0/arcgis/rest/services/Testing/FeatureServer/0"
        });

        const store = new FeatureStore({
          layer
        });

        // Use layer fields to generate columns
        layer.when(() => grid.set("columns", getColumns()));
        layer.load();

        const grid = new Grid({
          viewModel: new GridViewModel({
            // Modify 'dataProvider' to work with our custom store
            dataProvider: async function(params, callback) {
              const { page, pageSize, sortOrders, filters } = params;
              const orderByFields = getOrderByFieldsFromSortOrder(sortOrders);
              const where = getWhereClauseFromFilter(filters) || "1=1";
              // const where = "OBJECTID = 2";

              await store.set({
                orderByFields,
                where
              });

              if (store.state !== "loaded") {
                await store.load();
              }

              callback && callback(await store.query(params));
            },
            store
          }),
          container: document.getElementById("grid")
        });

        // Generate 'columns' from layer fields
        // Requires using a custom renderer to work with our custom store
        function getColumns() {
          if (!layer.fields) {
            return [];
          }

          const renderFunction = ({ root, column, rowData }) => {
            if (
              !column ||
              !column.path ||
              !rowData ||
              !rowData.item ||
              !rowData.item.feature
            ) {
              return "";
            }

            root.innerHTML = rowData.item.feature.attributes[column.path] || "";
          };

          return layer.fields.map(field => {
            return new Column({
              path: field.name,
              header: field.alias || field.name,
              // sortable: true,
              renderFunction
              // headerRenderFunction: ({ root }) => {
              //   root.innerHTML = "test123";
              // }
            });
          });
        }

        // Converts 'sortOrder' from Vaadin-Grid to correct format for 'orderByFields' for layer query
        function getOrderByFieldsFromSortOrder(orders) {
          if (!orders || !orders.length) {
            return [];
          }

          return orders
            .filter(
              (order, pos, arr) =>
                arr.map(ord => ord.path).indexOf(order.path) === pos
            )
            .map(({ direction, path }) => path + " " + direction.toUpperCase());
        }

        // Converts 'filters' from Vaadin-Grid to correct format for 'where' clause for layer query
        function getWhereClauseFromFilter(filters) {
          return filters
            .filter(
              ({ value }) =>
                value !== null && value !== undefined && value !== ""
            )
            .map(
              (filter, i) =>
                (i > 0 ? " AND " : "") +
                `${filter.path} LIKE '%${filter.value}%'`
            )
            .join(""); // TODO - breaks querying in some workflows
        }

        console.log("layer: ", layer);
        console.log("store: ", store);
        console.log("grid: ", grid);
      });
    </script>
  </head>

  <body>
    <div class="container"><div id="grid"></div></div>
  </body>
</html>
