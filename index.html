<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>Swipe Widget with Scroll - 4.14</title>

    <link rel="stylesheet" href="/git/arcgis-js-api-4/esri/css/main.css" />
    <script src="/git/arcgis-js-api-4/test-apps/dojo-config.js"></script>
    <script src="/git/arcgis-js-api-4/dojo/dojo.js"></script>

    <!-- <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.14/esri/themes/light/main.css"
    />
    <script src="https://js.arcgis.com/4.14/"></script> -->

    <link rel="stylesheet" href="app.css" />

    <script>
      require([
        "esri/WebMap",
        "esri/views/MapView",
        "esri/widgets/Swipe",
        "esri/widgets/Legend",
        "esri/widgets/Slider",
        "esri/widgets/FeatureTable/support/FeatureStore",
        "esri/widgets/FeatureTable/Grid/Column",
        "esri/widgets/FeatureTable/Grid/Grid",
        "esri/widgets/FeatureTable/Grid/GridViewModel"
      ], function(
        WebMap,
        MapView,
        Swipe,
        Legend,
        Slider,
        FeatureStore,
        Column,
        Grid,
        GridViewModel
      ) {
        let view, swipes;

        const scroller = document.querySelector(".scroller");
        const content = scroller.querySelector(".content");

        // initialize the map
        const map = new WebMap({
          portalItem: {
            id: "692c3794ebd24099a8ad9116b8440bff"
          }
        });

        map
          .load()
          .then(function() {
            // create the view
            view = new MapView({
              container: "viewDiv",
              map: map,
              zoom: 5,
              center: [-98.5795, 39.8283],
              padding: {
                right: 350
              }
            });

            view.on("mouse-wheel", function(event) {
              scroller.scrollTop = scroller.scrollTop + event.deltaY;
              event.stopPropagation();
            });

            const featureTableToggle = document.createElement("button");
            featureTableToggle.title = "Feature table";
            featureTableToggle.addEventListener("click", function() {
              gridDiv.toggleAttribute("hidden");
              if (!featureTable) {
                setupFeatureTable();
              }
            });
            featureTableToggle.className =
              "esri-widget--button esri-icon-table feature-table-button";
            view.ui.add(featureTableToggle, "top-left");

            // get the layers from the webmap
            const layers = map.layers;

            // create a swipe widget for each layer
            swipes = layers.map(function(layer) {
              return new Swipe({
                view: view,
                disabled: true,
                position: 100,
                direction: "vertical",
                trailingLayers: [layer],
                visibleElements: {
                  handle: false,
                  divider: true
                }
              });
            });

            let featureTable = null;

            const gridDiv = document.createElement("div");
            gridDiv.id = "gridDiv";
            gridDiv.hidden = true;
            view.ui.add(gridDiv, "manual");

            function setupFeatureTable() {
              // Generate 'columns' from layer fields
              // Requires using a custom renderer to work with our custom store
              function getColumns() {
                if (!layer.fields) {
                  return [];
                }

                const renderFunction = ({ root, column, rowData }) => {
                  if (
                    !column ||
                    !column.path ||
                    !rowData ||
                    !rowData.item ||
                    !rowData.item.feature
                  ) {
                    return "";
                  }

                  root.innerHTML =
                    rowData.item.feature.attributes[column.path] || "";
                };

                const ignoredFields = [
                  "wfo",
                  "etn",
                  "shape__area",
                  "shape__length",
                  "issuedate",
                  "status"
                ];

                return layer.fields
                  .filter(
                    field =>
                      ignoredFields.indexOf(field.name.toLowerCase()) === -1
                  )
                  .map(field => {
                    return new Column({
                      path: field.name,
                      header: field.alias || field.name,
                      // sortable: true,
                      renderFunction
                      // headerRenderFunction: ({ root }) => {
                      //   root.innerHTML = "test123";
                      // }
                    });
                  });
              }

              // Converts 'sortOrder' from Vaadin-Grid to correct format for 'orderByFields' for layer query
              function getOrderByFieldsFromSortOrder(orders) {
                if (!orders || !orders.length) {
                  return [];
                }

                return orders
                  .filter(
                    (order, pos, arr) =>
                      arr.map(ord => ord.path).indexOf(order.path) === pos
                  )
                  .map(
                    ({ direction, path }) =>
                      path + " " + direction.toUpperCase()
                  );
              }

              // Converts 'filters' from Vaadin-Grid to correct format for 'where' clause for layer query
              function getWhereClauseFromFilter(filters) {
                return filters
                  .filter(
                    ({ value }) =>
                      value !== null && value !== undefined && value !== ""
                  )
                  .map(
                    (filter, i) =>
                      (i > 0 ? " AND " : "") +
                      `${filter.path} LIKE '%${filter.value}%'`
                  )
                  .join(""); // TODO - breaks querying in some workflows
              }

              const layer = layers.getItemAt(0);
              const store = new FeatureStore({
                layer
              });

              featureTable = new Grid({
                viewModel: new GridViewModel({
                  // Modify 'dataProvider' to work with our custom store
                  dataProvider: async function(params, callback) {
                    const { page, pageSize, sortOrders, filters } = params;
                    const orderByFields = getOrderByFieldsFromSortOrder(
                      sortOrders
                    );
                    const where = getWhereClauseFromFilter(filters) || "1=1";
                    // const where = "OBJECTID = 2";

                    await store.set({
                      orderByFields,
                      where
                    });

                    if (store.state !== "loaded") {
                      await store.load();
                    }

                    callback && callback(await store.query(params));
                  },
                  store
                }),
                container: gridDiv
              });

              // Use layer fields to generate columns
              layer.when(() => featureTable.set("columns", getColumns()));
            }

            // create a legend for each layer and add it to the map
            layers.forEach(function(layer, index) {
              const slide = document.createElement("div");
              slide.className = "slide";
              const heading = document.createElement("h2");
              heading.className = "heading";
              heading.textContent = `${layer.title} Tornado Warnings 2002-2011`;
              slide.appendChild(heading);

              const legendDiv = document.createElement("div");
              legendDiv.className = "legend";
              const legend = new Legend({
                container: legendDiv,
                view: view,
                layerInfos: [
                  {
                    layer: layer
                  }
                ]
              });
              slide.appendChild(legendDiv);

              content.appendChild(slide);
            });

            return view.when();
          })
          .then(function() {
            let height = 0;

            function updateSize() {
              height = view.height * swipes.length;
              setScroll(scroller.scrollTop);
              content.style.height = height + "px";
            }

            function clamp(value, min, max) {
              return Math.min(max, Math.max(min, value));
            }

            let scroll = 0;
            let ticking = false;
            function setScroll(value) {
              scroll = value;

              if (!ticking) {
                requestAnimationFrame(function() {
                  ticking = false;

                  let pageRatio = scroll / view.height;

                  swipes.forEach(function(swipe, index, swipes) {
                    // add each swipe to the view UI
                    view.ui.add(swipe);

                    let position = (index - pageRatio) * 100;

                    // To achieve this infinite scroll effect we need to swap the layers:
                    //   The layer starts at the bottom, the divider goes up
                    //   Then the next layer starts to show up, so we put back the divider at the bottom and swap the layers.
                    if (position < 0 && swipe.trailingLayers.length) {
                      swipe.leadingLayers.addMany(swipe.trailingLayers);
                      swipe.trailingLayers.removeAll();
                    } else if (position >= 0 && swipe.leadingLayers.length) {
                      swipe.trailingLayers.addMany(swipe.leadingLayers);
                      swipe.leadingLayers.removeAll();
                    }

                    if (position < 0) {
                      position += 100;
                    }

                    swipe.position = clamp(position, 0, 100);
                  });
                });

                ticking = true;
              }
            }

            view.watch("height", updateSize);
            updateSize();

            // show layer legends after map has loaded
            const legendDivs = document.getElementsByClassName("legend");
            for (let i = 0; i < legendDivs.length; i++) {
              legendDivs[i].style.visibility = "visible";
            }

            // stop default scroll
            scroller.addEventListener("wheel", function(event) {
              event.stopImmediatePropagation();
            });

            scroller.addEventListener("scroll", function() {
              setScroll(scroller.scrollTop);
            });
          })
          .catch(function(error) {
            console.error(error);
          });
      });
    </script>
  </head>

  <body>
    <div id="viewDiv"></div>
    <div class="scroller">
      <div class="content"></div>
    </div>
  </body>
</html>
