<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>Swipe Widget with Scroll - 4.14</title>

    <link rel="stylesheet" href="/git/arcgis-js-api-4/esri/css/main.css" />
    <script src="/git/arcgis-js-api-4/test-apps/dojo-config.js"></script>
    <script src="/git/arcgis-js-api-4/dojo/dojo.js"></script>

    <!-- <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.14/esri/themes/light/main.css"
    />
    <script src="https://js.arcgis.com/4.14/"></script> -->

    <link rel="stylesheet" href="app.css" />

    <script>
      require([
        "esri/WebMap",
        "esri/views/MapView",
        "esri/widgets/Swipe",
        "esri/widgets/Legend",
        "esri/widgets/FeatureTable"
      ], function(WebMap, MapView, Swipe, Legend, FeatureTable) {
        let view, swipes;

        const scroller = document.querySelector(".scroller");
        const content = scroller.querySelector(".content");

        // initialize the map
        const map = new WebMap({
          portalItem: {
            id: "692c3794ebd24099a8ad9116b8440bff"
          }
        });

        map
          .load()
          .then(function() {
            // create the view
            view = new MapView({
              container: "viewDiv",
              map: map,
              zoom: 5,
              center: [-98.5795, 39.8283],
              padding: {
                right: 350
              }
            });

            view.on("mouse-wheel", function(event) {
              scroller.scrollTop = scroller.scrollTop + event.deltaY;
              event.stopPropagation();
            });

            const tableToggle = document.createElement("button");
            tableToggle.title = "Feature table";
            tableToggle.addEventListener("click", function() {
              tableDiv.toggleAttribute("hidden");
              if (!table) {
                setupFeatureTable();
              }
            });
            tableToggle.className =
              "esri-widget--button esri-icon-table feature-table-button";
            view.ui.add(tableToggle, "top-left");

            // get the layers from the webmap
            const layers = map.layers;

            // create a swipe widget for each layer
            swipes = layers.map(function(layer) {
              return new Swipe({
                view: view,
                disabled: true,
                position: 100,
                direction: "vertical",
                trailingLayers: [layer],
                visibleElements: {
                  handle: false,
                  divider: true
                }
              });
            });

            let table = null;

            const tableDiv = document.createElement("div");
            tableDiv.id = "tableDiv";
            tableDiv.hidden = true;
            view.ui.add(tableDiv, "manual");

            function setupFeatureTable() {
              table = new FeatureTable({
                layer: layers.getItemAt(0),
                container: tableDiv
              });
            }

            // create a legend for each layer and add it to the map
            layers.forEach(function(layer, index) {
              const slide = document.createElement("div");
              slide.className = "slide";
              const heading = document.createElement("h2");
              heading.className = "heading";
              heading.textContent = `${layer.title} Tornado Warnings 2002-2011`;
              slide.appendChild(heading);

              const legendDiv = document.createElement("div");
              legendDiv.className = "legend";
              const legend = new Legend({
                container: legendDiv,
                view: view,
                layerInfos: [
                  {
                    layer: layer
                  }
                ]
              });
              slide.appendChild(legendDiv);

              content.appendChild(slide);
            });

            return view.when();
          })
          .then(function() {
            let height = 0;

            function updateSize() {
              height = view.height * swipes.length;
              setScroll(scroller.scrollTop);
              content.style.height = height + "px";
            }

            function clamp(value, min, max) {
              return Math.min(max, Math.max(min, value));
            }

            let scroll = 0;
            let ticking = false;
            function setScroll(value) {
              scroll = value;

              if (!ticking) {
                requestAnimationFrame(function() {
                  ticking = false;

                  let pageRatio = scroll / view.height;

                  swipes.forEach(function(swipe, index, swipes) {
                    // add each swipe to the view UI
                    view.ui.add(swipe);

                    let position = (index - pageRatio) * 100;

                    // To achieve this infinite scroll effect we need to swap the layers:
                    //   The layer starts at the bottom, the divider goes up
                    //   Then the next layer starts to show up, so we put back the divider at the bottom and swap the layers.
                    if (position < 0 && swipe.trailingLayers.length) {
                      swipe.leadingLayers.addMany(swipe.trailingLayers);
                      swipe.trailingLayers.removeAll();
                    } else if (position >= 0 && swipe.leadingLayers.length) {
                      swipe.trailingLayers.addMany(swipe.leadingLayers);
                      swipe.leadingLayers.removeAll();
                    }

                    if (position < 0) {
                      position += 100;
                    }

                    swipe.position = clamp(position, 0, 100);
                  });
                });

                ticking = true;
              }
            }

            view.watch("height", updateSize);
            updateSize();

            // show layer legends after map has loaded
            const legendDivs = document.getElementsByClassName("legend");
            for (let i = 0; i < legendDivs.length; i++) {
              legendDivs[i].style.visibility = "visible";
            }

            // stop default scroll
            scroller.addEventListener("wheel", function(event) {
              event.stopImmediatePropagation();
            });

            scroller.addEventListener("scroll", function() {
              setScroll(scroller.scrollTop);
            });
          })
          .catch(function(error) {
            console.error(error);
          });
      });
    </script>
  </head>

  <body>
    <div id="viewDiv"></div>
    <div class="scroller">
      <div class="content"></div>
    </div>
  </body>
</html>
